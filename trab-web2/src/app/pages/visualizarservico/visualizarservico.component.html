<app-navbar></app-navbar>

<div class="container mt-4">
  
  <!--
    A diretiva *ngIf garante que este bloco só será renderizado quando 'solicitacao'
    tiver um valor, prevenindo o erro "Object is possibly 'undefined'".
    'else loadingTemplate' mostra um feedback de carregamento.
  -->
  <div *ngIf="solicitacao; else loadingTemplate">
    <h2 class="mb-4">Detalhes da Solicitação</h2>

    <!-- Detalhes Principais e do Equipamento -->
    <div class="row">
      <div class="col-md-12">
        <div class="card mb-4">
          <div class="card-header d-flex justify-content-between align-items-center">
            <strong>Solicitação #{{ solicitacao.id }}</strong>
            <span class="badge rounded-pill" [ngClass]="{
              'bg-secondary': solicitacao.estado === 'Pendente',
              'bg-info text-dark': solicitacao.estado === 'Orçada',
              'bg-danger': solicitacao.estado === 'Rejeitada',
              'bg-warning text-dark': solicitacao.estado === 'Aprovada',
              'bg-primary': solicitacao.estado === 'Arrumada',
              'bg-success': solicitacao.estado === 'Paga' || solicitacao.estado === 'Finalizada'
            }">
              {{ solicitacao.estado }}
            </span>
          </div>
          <div class="card-body">
            <p><strong>Data de Abertura:</strong> {{ solicitacao.dataHora | date:'dd/MM/yyyy HH:mm' }}</p>
            <p><strong>Equipamento:</strong> {{ solicitacao.descricaoEquipamento }} ({{ solicitacao.categoriaEquipamento }})</p>
            <p><strong>Defeito Reportado:</strong> {{ solicitacao.descricaoDefeito }}</p>
            <p><strong>Funcionário Responsável:</strong> {{ nomeFuncionarioResponsavel }}</p>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Seção do Orçamento (só aparece se houver um) -->
    <ng-container *ngIf="solicitacao.valorOrcamento">
      <div class="card mb-4">
        <div class="card-header">
          <strong>Detalhes do Orçamento</strong>
        </div>
        <div class="card-body">
          <p><strong>Valor:</strong> {{ solicitacao.valorOrcamento | currency:'BRL' }}</p>
          <p><strong>Orçado por:</strong> {{ nomeFuncionarioOrcamento }}</p>
          <p *ngIf="solicitacao.observacoesOrcamento"><strong>Observações:</strong> {{ solicitacao.observacoesOrcamento }}</p>
        </div>
      </div>
    </ng-container>

    <!-- Histórico de Atualizações -->
    <h4 class="mb-3">Histórico</h4>
    <ul class="list-group mb-4">
      <li class="list-group-item" *ngFor="let h of solicitacao.historicoSolicitacao">
        <div>
          <strong>{{ h.dataHora | date:'dd/MM/yyyy HH:mm' }}</strong> – Novo estado: 
          <span class="badge" [ngClass]="{
            'bg-secondary': h.estado === 'Pendente',
            'bg-info text-dark': h.estado === 'Orçada',
            'bg-danger': h.estado === 'Rejeitada',
            'bg-warning text-dark': h.estado === 'Aprovada',
            'bg-primary': h.estado === 'Arrumada',
            'bg-success': h.estado === 'Paga' || h.estado === 'Finalizada'
          }">{{ h.estado }}</span>
          <!-- Nota: Para exibir o nome do funcionário no histórico, seria necessário carregar um mapa de todos os funcionários -->
          <span *ngIf="h.funcionarioId"> (por ID: {{ h.funcionarioId }})</span>
        </div>
        <em *ngIf="h.observacao" class="d-block mt-1 text-muted">{{ h.observacao }}</em>
      </li>
    </ul>

    <!-- Botões de Ação para o Cliente -->
    <div class="d-flex gap-2">
      <!-- Orçada: leva para a tela de aprovação (se houver) -->
      <button *ngIf="solicitacao.estado === 'Orçada'" class="btn btn-primary" (click)="resgatar()">
        Aprovar Orçamento
      </button>

      <!-- Arrumada: leva ao pagamento -->
      <button *ngIf="solicitacao.estado === 'Arrumada'" class="btn btn-success" [routerLink]="['/pagarservico', solicitacao.dataHora]">
        Ir para Pagamento
      </button>

      <!-- Botão para voltar -->
      <a class="btn btn-secondary" [routerLink]="['/paginainicialcliente']">Voltar</a>
    </div>

  </div>

  <!-- Template que é exibido enquanto os dados estão sendo carregados -->
  <ng-template #loadingTemplate>
    <div *ngIf="isLoading" class="text-center mt-5">
      <div class="spinner-border" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="mt-2">Carregando detalhes...</p>
    </div>
  </ng-template>

</div>
